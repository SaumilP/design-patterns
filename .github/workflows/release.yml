name: Build Book and Publish Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Pandoc + TeX and Chromium deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-extra \
            librsvg2-bin \
            libgbm1 \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libxss1 \
            libxtst6 \
            fonts-liberation \
            ca-certificates \
            lsb-release \
            xdg-utils \
            zip
          sudo apt-get install -y libasound2 || sudo apt-get install -y libasound2t64

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Mermaid CLI
        run: |
          npm install -g @mermaid-js/mermaid-cli
      
      - name: Verify Mermaid CLI
        run: |
          if ! command -v mmdc >/dev/null 2>&1; then
            npm install -g @mermaid-js/mermaid-cli
          fi
          mmdc --version || true

      - name: Mermaid smoke test (Chromium/Puppeteer)
        id: mermaid_smoke
        continue-on-error: true
        run: |
          mkdir -p book-output/diagrams
          cat > book-output/diagrams/smoke.mmd <<'MMD'
          sequenceDiagram
              participant A
              participant B
              A->>B: hello
          MMD
          cat > book-output/diagrams/puppeteer-smoke.json <<'JSON'
          { "args": ["--no-sandbox", "--disable-setuid-sandbox"] }
          JSON
          mmdc \
            -i book-output/diagrams/smoke.mmd \
            -o book-output/diagrams/smoke.png \
            --backgroundColor "#ffffff" \
            --puppeteerConfigFile book-output/diagrams/puppeteer-smoke.json

      - name: Verify rsvg-convert
        run: |
          command -v rsvg-convert && rsvg-convert --version || echo "rsvg-convert not found"

      - name: Generate master markdown
        run: |
          mkdir -p book-output
          cat > book-output/design-patterns-book.md <<EOF
          ---
          title: "Design Patterns in Java"
          subtitle: "Practical, Runnable Examples"
          date: "$(date -u +'%Y-%m-%d %H:%M UTC')"
          lang: en
          ---

          EOF

          if [ -f "README.md" ]; then
            echo "---" >> book-output/design-patterns-book.md
            echo "" >> book-output/design-patterns-book.md
            cat README.md >> book-output/design-patterns-book.md
            echo "" >> book-output/design-patterns-book.md
          fi

          categories=( \
            gof-patterns \
            enterprise-integration-patterns \
            reliability-patterns \
            architectural-patterns \
            miscellaneous-patterns \
          )

          for category in "${categories[@]}"; do
            if [ -f "$category/README.md" ]; then
              echo "---" >> book-output/design-patterns-book.md
              echo "" >> book-output/design-patterns-book.md
              cat "$category/README.md" >> book-output/design-patterns-book.md
              echo "" >> book-output/design-patterns-book.md
            fi

            for pattern_dir in $(ls -d "$category"/*/ 2>/dev/null | sort); do
              if [ -f "$pattern_dir/README.md" ]; then
                echo "---" >> book-output/design-patterns-book.md
                echo "" >> book-output/design-patterns-book.md
                cat "$pattern_dir/README.md" >> book-output/design-patterns-book.md
                echo "" >> book-output/design-patterns-book.md
              fi
            done
          done

      - name: Render Mermaid diagrams
        if: ${{ steps.mermaid_smoke.outcome == 'success' }}
        id: render_mermaid
        continue-on-error: true
        run: |
          mkdir -p book-output/diagrams
          python3 scripts/render_mermaid.py \
            book-output/design-patterns-book.md \
            book-output/design-patterns-book.with-diagrams.md \
            book-output/diagrams

      - name: Build HTML
        if: ${{ steps.render_mermaid.outcome == 'success' }}
        id: build_html
        continue-on-error: true
        run: |
          mkdir -p book-output/html
          pandoc book-output/design-patterns-book.with-diagrams.md \
            -o book-output/html/index.html \
            --standalone \
            --css=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css \
            --resource-path=book-output \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            --highlight-style=pygments

      - name: Copy diagrams into HTML output
        if: ${{ steps.build_html.outcome == 'success' }}
        run: |
          mkdir -p book-output/html/diagrams
          cp book-output/diagrams/*.png book-output/html/diagrams/ || true

      - name: Sanitize markdown for LaTeX PDF
        if: ${{ steps.render_mermaid.outcome == 'success' }}
        run: |
          python3 - <<'PY'
          from pathlib import Path

          p = Path("book-output/design-patterns-book.with-diagrams.md")
          s = p.read_text(encoding="utf-8")

          # Replace common escape sequences that break LaTeX when they appear in normal text.
          # These are intended to render as literal characters in the final PDF.
          s = s.replace(r"\n", r"\\textbackslash n")
          s = s.replace(r"\t", r"\\textbackslash t")
          s = s.replace(r"\r", r"\\textbackslash r")

          p.write_text(s, encoding="utf-8")
          print("Sanitized book-output/design-patterns-book.with-diagrams.md")
          PY

      - name: Debug LaTeX output (if PDF fails)
        if: ${{ steps.build_pdf.outcome == 'failure' }}
        run: |
          pandoc --from=gfm --resource-path=book-output book-output/design-patterns-book.with-diagrams.md -t latex -o book-output/debug.tex || true
          nl -ba book-output/debug.tex | sed -n '470,520p' || true

      - name: Build PDF
        if: ${{ steps.render_mermaid.outcome == 'success' }}
        id: build_pdf
        continue-on-error: true
        run: |
          mkdir -p book-output/pdf
          pandoc --from=gfm --resource-path=book-output --top-level-division=chapter \
            --template=book/latex/template.tex \
            --include-in-header=book/latex/header.tex \
            book-output/design-patterns-book.with-diagrams.md \
            -o book-output/pdf/design-patterns-book.pdf \
            2> book-output/pdf/pandoc-pdf.log \
            --pdf-engine=xelatex \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            -V geometry:margin=1in \
            -V fontsize=11pt \
            -V documentclass=book
          if grep -n "Could not fetch resource diagrams/" book-output/pdf/pandoc-pdf.log; then
            echo "ERROR: Missing local diagram resources (diagrams/*)."
            exit 1
          fi

      - name: Package HTML site
        if: ${{ steps.build_html.outcome == 'success' }}
        run: |
          cd book-output/html
          zip -r ../design-patterns-html.zip .
          cd ..

      - name: Upload workflow artifacts (manual runs)
        if: ${{ github.event_name == 'workflow_dispatch' && steps.mermaid_smoke.outcome == 'success' && steps.render_mermaid.outcome == 'success' && steps.build_html.outcome == 'success' && steps.build_pdf.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: design-patterns-book
          path: |
            book-output/pdf/design-patterns-book.pdf
            book-output/design-patterns-html.zip
            book-output/design-patterns-book.md

      - name: Upload debug artifacts (on failure)
        if: ${{ steps.mermaid_smoke.outcome == 'failure' || steps.render_mermaid.outcome == 'failure' || steps.build_html.outcome == 'failure' || steps.build_pdf.outcome == 'failure' }}
        uses: actions/upload-artifact@v4
        with:
          name: design-patterns-book-debug
          if-no-files-found: ignore
          path: |
            book-output/debug.tex
            book-output/design-patterns-book.with-diagrams.md
            book-output/diagrams
            book-output/pdf/pandoc-pdf.log

      - name: Create GitHub Release and upload assets
        if: ${{ startsWith(github.ref, 'refs/tags/') && steps.mermaid_smoke.outcome == 'success' && steps.render_mermaid.outcome == 'success' && steps.build_html.outcome == 'success' && steps.build_pdf.outcome == 'success' }}
        uses: softprops/action-gh-release@v2
        with:
          files: |
            book-output/design-patterns-book.md
            book-output/pdf/design-patterns-book.pdf
            book-output/design-patterns-html.zip

      - name: Fail job if book build failed
        if: ${{ steps.mermaid_smoke.outcome == 'failure' || steps.render_mermaid.outcome == 'failure' || steps.build_html.outcome == 'failure' || steps.build_pdf.outcome == 'failure' }}
        run: |
          echo "Book build failed:"
          echo "  Mermaid smoke:  ${{ steps.mermaid_smoke.outcome }}"
          echo "  Render Mermaid: ${{ steps.render_mermaid.outcome }}"
          echo "  Build HTML:     ${{ steps.build_html.outcome }}"
          echo "  Build PDF:      ${{ steps.build_pdf.outcome }}"
          exit 1
