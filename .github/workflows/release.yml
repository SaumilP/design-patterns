name: Build Book and Publish Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Install Pandoc + TeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-fonts-recommended \
            texlive-latex-extra \
            librsvg2-bin \
            zip
      
      - name: Verify rsvg-convert
        run: |
          command -v rsvg-convert && rsvg-convert --version || echo "rsvg-convert not found"

      - name: Generate master markdown
        run: |
          mkdir -p book-output
          echo "# Design Patterns - Comprehensive Guide" > book-output/design-patterns-book.md
          echo "" >> book-output/design-patterns-book.md
          echo "Generated: $(date -u)" >> book-output/design-patterns-book.md
          echo "" >> book-output/design-patterns-book.md

          if [ -f "README.md" ]; then
            echo "---" >> book-output/design-patterns-book.md
            echo "" >> book-output/design-patterns-book.md
            cat README.md >> book-output/design-patterns-book.md
            echo "" >> book-output/design-patterns-book.md
          fi

          for pattern in $(ls -d */ | grep -v "^\." | sort | sed 's/\///'); do
            if [ -f "$pattern/README.md" ]; then
              echo "---" >> book-output/design-patterns-book.md
              echo "" >> book-output/design-patterns-book.md
              cat "$pattern/README.md" >> book-output/design-patterns-book.md
              echo "" >> book-output/design-patterns-book.md
            fi
          done

      - name: Build HTML
        run: |
          mkdir -p book-output/html
          pandoc book-output/design-patterns-book.md \
            -o book-output/html/index.html \
            --standalone \
            --css=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            --highlight-style=pygments

      - name: Sanitize markdown for LaTeX PDF
        run: |
          python3 - <<'PY'
          from pathlib import Path

          p = Path("book-output/design-patterns-book.md")
          s = p.read_text(encoding="utf-8")

          # Replace common escape sequences that break LaTeX when they appear in normal text.
          # These are intended to render as literal characters in the final PDF.
          s = s.replace(r"\n", r"\\textbackslash n")
          s = s.replace(r"\t", r"\\textbackslash t")
          s = s.replace(r"\r", r"\\textbackslash r")

          p.write_text(s, encoding="utf-8")
          print("Sanitized book-output/design-patterns-book.md")
          PY

      - name: Debug LaTeX output (if PDF fails)
        if: failure()
        run: |
          pandoc --from=gfm book-output/design-patterns-book.md -t latex -o book-output/debug.tex || true
          nl -ba book-output/debug.tex | sed -n '470,520p' || true

      - name: Build PDF
        run: |
          mkdir -p book-output/pdf
          pandoc --from=gfm book-output/design-patterns-book.md \
            -o book-output/pdf/design-patterns-book.pdf \
            --pdf-engine=xelatex \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            -V geometry:margin=1in \
            -V fontsize=11pt \
            -V documentclass=article

      - name: Package HTML site
        run: |
          cd book-output/html
          zip -r ../design-patterns-html.zip .
          cd ..

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            book-output/design-patterns-book.md
            book-output/pdf/design-patterns-book.pdf
            book-output/design-patterns-html.zip
