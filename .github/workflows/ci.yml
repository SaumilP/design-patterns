name: Java CI - Build, Test & Documentation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: Maven Build
        run: mvn clean package -DskipTests

      - name: Maven Test
        run: mvn clean test

      - name: Install Pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Generate Book from README Files
        run: |
          mkdir -p book-output
          
          # Create a master document combining all README files
          echo "# Design Patterns - Comprehensive Guide" > book-output/design-patterns-book.md
          echo "" >> book-output/design-patterns-book.md
          echo "**Generated: $(date)**" >> book-output/design-patterns-book.md
          echo "" >> book-output/design-patterns-book.md
          
          # Add root README
          if [ -f "README.md" ]; then
            echo "---" >> book-output/design-patterns-book.md
            echo "" >> book-output/design-patterns-book.md
            cat README.md >> book-output/design-patterns-book.md
            echo "" >> book-output/design-patterns-book.md
          fi
          
          # Add individual pattern READMEs in sorted order
          for pattern in $(ls -d */ | grep -v "^\." | sort | sed 's/\///'); do
            if [ -f "$pattern/README.md" ]; then
              echo "---" >> book-output/design-patterns-book.md
              echo "" >> book-output/design-patterns-book.md
              cat "$pattern/README.md" >> book-output/design-patterns-book.md
              echo "" >> book-output/design-patterns-book.md
            fi
          done
          
          echo "✅ Master markdown document created: book-output/design-patterns-book.md"

      - name: Convert Markdown to PDF
        run: |
          mkdir -p book-output/pdf
          pandoc book-output/design-patterns-book.md \
            -o book-output/pdf/design-patterns-book.pdf \
            --pdf-engine=xelatex \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            -V geometry:margin=1in \
            -V fontsize=11pt \
            -V documentclass=article \
            2>/dev/null || \
          pandoc book-output/design-patterns-book.md \
            -o book-output/pdf/design-patterns-book.pdf \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            2>/dev/null || \
          echo "⚠️ PDF generation skipped (LaTeX not available, using HTML instead)"

      - name: Convert Markdown to HTML
        run: |
          mkdir -p book-output/html
          pandoc book-output/design-patterns-book.md \
            -o book-output/html/index.html \
            --standalone \
            --css=https://cdn.jsdelivr.net/npm/water.css@2/out/water.css \
            --table-of-contents \
            --toc-depth=3 \
            --number-sections \
            --highlight-style=pygments
          echo "✅ HTML book generated: book-output/html/index.html"

      - name: Setup Pages
        if: github.event_name == 'push'
        uses: actions/configure-pages@v4

      - name: Upload artifact to GitHub Pages
        if: github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'book-output/html'

      - name: Deploy to GitHub Pages
        if: github.event_name == 'push'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create Release and Upload Artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/main')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            book-output/design-patterns-book.md
            book-output/pdf/design-patterns-book.pdf
            book-output/html/index.html
          tag_name: v${{ github.run_number }}
          release_name: Design Patterns Documentation v${{ github.run_number }}
          body: |
            ## Design Patterns Documentation Release
            
            This release includes comprehensive design pattern documentation with:
            - ✅ All 37 design patterns documented
            - ✅ Markdown master guide
            - ✅ HTML version for web viewing
            - ✅ PDF version for offline reading
            
            Generated: ${{ github.event.head_commit.timestamp }}
            Commit: ${{ github.event.head_commit.message }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}